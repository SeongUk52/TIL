# 챕터 4 스트림 소개

> #### 이 장의 내용
> - 스트림이란 무엇인가?
> - 컬렉션과 스트림
> - 내부 반복과 외부 반복
> - 중간 연산과 최종 연산

- 컬렉션으로 데이터를 그룹화하고 처리할 수 있다.

## 4.1 스트림이란 무엇인가?
- 스트림(Stream)은 자바 8 API에 새로 추가된 기능이다. 스트림을 이용하면 선언형
(즉, 데이터를 처리하는 임시 구현 코드 대신 질의로 표현할 수 있다)으로 컬렉션 데이터를 처리할 수 있다.
- 스트림을 이용하면 멀티스레드 코드를 구현하지 않아도 데이터를 **투명하게** 병렬로 처리할 수 있다.
  - stream()을 parallelStream()으로 바꾸면 이 코드를 멀티코어 아키텍처에서 병렬로 실행할 수 있다.

자바 8의 스트림 API의 특징을 다음처럼 요약할 수 있다.
- 선언형: 더 간결하고 가독성이 좋아진다.
- 조립할 수 있음: 유연성이 좋아진다.
- 병렬화: 성능이 좋아진다.

## 4.2 스트림 시작하기
- 자바 8 컬렉션에는 스트림을 반환하는 stream 메서드가 추가됐다.
  (스트림의 인터페이스 정의는 java.util.stream.Stream 참고)
  - 스트림이란: 데이터 처리 연산을 지원하도록 소스에서 추출된 연속된 요소(Sequenece of elements)
    - 연속된 요소: 컬렉션과 마찬가지로 스트림은 특정 요소 형식으로 이루어진 연속된 값 집합의 인터페이스를 제공한다.
      - 컬렉션은 자료구조이므로 컬렉션에서는 시간과 공간의 복잡성과 관련된 요소 저장 및 접근 연산이 주를 이룬다.
        - 즉, 컬렉션의 주제는 데이터고 스트림의 주제는 계산이다.
  - 소스: 스트림은 컬렉션, 배열, I/O 자원 등의 데이터 제공 소스로부터 데이터를 소비한다.
    - 정렬된 컬렉션으로 스트림을 생성하면 정렬이 그대로 유지된다. 즉, 리스트로 스트림을 만들면 스트림의 요소는 리스트의 요소와 같은 순서를 유지한다.
  - 데이터 처리 연산: 스트림은 함수형 프로그래밍 언어에서 일반적으로 지원하는 연산과 데이터베이스와 비슷한 연산을 지원한다.
    - 예를 들어 filter, map, reduce, find, match, sort 등으로 데이터를 조작할 수 있다. 스트림 연산은 순차적으로 또는 병렬로
실행할 수 있다.

- 또한 스트림에는 다음과 같은 두 가지 중요한 특징이 있다.
  - 파이프라이닝(pipelining): 대부분이 스트림 연산은 스트림 연산끼리 연결해서 커다란 파이프라인을 구성할 수 있도록 스트림 자신을 반환한다.
    - 그 덕분에 게으름, 쇼트서킷 같은 최적화도 얻을 수 있다.
      - 연산 파이프라인은 데이터 소스에 적용하는 데이터베이스 질의와 비슷하다.
  - 내부 반복: 반복자를 이용해서 명시적으로 반복하는 컬렉션과 달리 스트림은 내부 반복을 지원한다. 
- 예제
  - 데이터 소스는 요리 리스트(메뉴)
    - 데이터 소스는 **연속된 요소**를 스트림에 제공한다.
      - 다음으로 스트림에 filter, map, limit, collect로 이어지는 일련의 **데이터 처리 연산**을 적용한다.
        - collect를 제외한 모든 연산은 서로 **파이프라인**을 형성할 수 있도록 스트림을 반환한다.
          - 파이프라인은 소스에 적용하는 질의 같은 존재다.
            - 마지막으로 collect 연산으로 파이프라인을 처리해서 결과를 반환한다. (collect는 스트림이 아니라 List를 반환한다.)
              - 마지막에 collect를 호출하기 전까지는 menu에서 무엇도 선택되지 않으며 출력 결과도 없다.
                - 즉, collect가 호출되기 전까지 메서드 호출이 저장되는 효과가 있다.
- filter: 람다를 인수로 받아 스트림에서 특정 요소를 제외시킨다. 
- map: 람다를 이용해서 한 요소를 다른 요소로 변환하거나 정보를 추출한다. 
- limit: 정해진 개수 이상의 요소가 스트림에 저장되지 못하게 스트림 크기를 축소 truncate한다.
- collect: 스트림을 다른 형식으로 변환한다. 

## 4.3 스트림과 컬렉션
- 자바의 기존 컬렉션과 새로운 스트림 모두 연속된 요소 형식의 값을 저장하는 자료구조의 인터페이스를 제공한다.
  - 연속된(sequenced) 이라는 표현은 순서와 상관없이 아무 값에나 접속 하는 것이 아니라 순차적으로 값에 접근한다는 것을 의미
- 데이터를 언제 계산하느냐가 컬렉션과 스트림의 가장 큰 차이
  - 컬렉션은 현재 자료구조가 포함하는 **모든** 값을 메모리에 저장하는 자료구조다. 즉, 컬렉션의 모든 요소는 컬렉션에 추가하기
전에 계산되어야 한다.
    - (컬렉션에 요소를 추가하거나 컬렉션의 요소를 삭제할 수 있다. 이런 연산을 수행할 때마다 컬렉션의 모든 요소를 메모리에
저장해야 하며 컬렉션에 추가하려는 요소는 미리 계산되어야 한다.)
  - 반면 스트림은 이론적으로 **요청할 때만 요소를 계산**하는 고정된 자료구조다.
    - (스트림에서 요소를 추가하거나 요소를 제거할 수 없다.)
      - 스트림은 생성자와 소비자 관계를 형성한다.
- 스트림은 게으르게 만들어지는 컬렉션과 같다.
  - 즉, 사용자가 데이터를 요청할 때만 값을 계산한다.
- 반면 컬렉션은 적극적으로 생성된다.


### 4.3.1 딱 한 번만 탐색할 수 있다.
- 반복자와 마찬가지로 스트림도 한 번만 탐색할 수 있다. 즉, 탐색된 스트림의 요소는 소비된다.


### 4.3.2 외부 반복과 내부 반복
- 컬렉션 인터페이스를 사용하려면 사용자가 직접 요소를 반복해야 한다(for-each), 이를 외부 반복(external iteration)이라고 한다.
- 스트림 라이브러리는 (반복을 알아서 처리하고 결과 스트림값을 어딘가에 저장해주는) 내부 반복(internal iteration)을 사용한다.
- 외부 반복에서는 병렬성을 스스로 관리해야 한다.

## 4.4 스트림 연산
- java.util.stream.Stream 인터페이스는 많은 연산을 정의한다.
- filter, map, limit는 서로 연결되어 파이프라인을 형성한다.
- collect로 파이프라인을 실행한 다음에 닫는다.
- 연결할 수 있는 스트림 연산을 **중간 연산(intermediate operation)** 이라고 하며
- 스트림을 닫는 연산을 **최종 연산(terminal operation)** 이라고 한다.


### 4.4.1 중간 연산
- filter나 sorted 같은 중간 연산은 다른 스트림을 반환한다.
  - 따라서 여러 중간 연산을 연결해서 질의를 만들 수 있다.
- 중간 연산의 중요한 특징은 단말 연산을 스트림 파이프라인에 실행하기 전까지는 아무 연산도 수행하지 않는다는 것
  - 즉, 게으르다.
    - 중간 연산을 합친다음에 합쳐진 중간 연산을 최종 연산으로 한 번에 처리하기 때문이다.
- 스트림의 게으른 특성 덕분에 몇 가지 최적화 효과를 얻을 수 있었다.
  - 첫째, 300칼로리가 넘는 요리는 여러 개지만 오직 처음 3개만 선택되었다.
    - 이는 limit연산 그리고 **쇼트서킷**이라 불리는 기법 덕분이다.
  - 둘째, filter와 map은 서로 다른 연산이지만 한 과정으로 병합되었다.
    - 이 기법을 **루프 퓨전(loop fusion)** 이라고 한다.

### 4.4.2 최종 연산
- 최종 연산은 스트림 파이프라인에서 결과를 도출한다. 보통 최종 연산에 의해 List, Integer, void 등 **스트림 이외의 결과가 반환**된다.

### 4.4.3 스트림 이용하기
- 스트림 이용 과정은 다음과 같이 세 가지로 요약할 수 있다.
  - 질의를 수행할 (컬렉션 같은) 데이터 소스
  - 스트림 파이프라인을 구성할 중간 연산 연결
  - 스트림 파이프라인을 실행하고 결과를 만들 최종 연산

## 4.5 로드맵

## 4.6 마치며
- 스트림은 소스에서 추출된 연속 요소로, 데이터 처리 연산을 지원한다.
- 스트림은 내부 반복을 지원한다. 내부 반복은 filter, map, sorted 등의 연산으로 반복을 추상화한다.
- 스트림에는 중간 연산과 최종 연산이 있다.
- 중간 연산은 filter와 map처럼 스트림을 반환하면서 다른 연산과 연결되는 연산이다. 중간 연산을 이용해서 파이프라인을 구성할 수 있지만
중간 연산으로는 어떤 결과도 생성할 수 없다.
- forEach나 count처럼 스트림 파이프라인을 처리해서 스트림이 아닌 결과를 반환하는 연산을 최종연산이라고 한다.
- 스트림의 요소는 요청할 때 게으르게 계산된다.


## 챕터4 독후감

---
스트림이 무엇인지 살펴보았고 복잡한 코드를 단순하게 바꿔주는 강력한 효과를 눈으로 보았다. 파트2를 다 읽고나서 스트림을 제대로 쓸 수 있도록
연습해봐야겠다.